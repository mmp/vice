name: CI

on:
  push:
    paths-ignore:
      - 'website/**'
      - '**.md'
  pull_request:
    paths-ignore:
      - 'website/**'
      - '**.md'

jobs:
  bundle-resources:
    name: Bundle Resources
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        lfs: false

    - name: Restore manifest from cache
      id: cache
      uses: actions/cache@v4
      with:
        path: manifest.json
        key: manifest-v2-${{ hashFiles('resources/**') }}

    - name: Setup Go
      if: steps.cache.outputs.cache-hit != 'true' && github.event_name != 'pull_request'
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache-dependency-path: go.sum

    - name: Fetch LFS and generate manifest
      if: steps.cache.outputs.cache-hit != 'true' && github.event_name != 'pull_request'
      env:
        R2_ACCOUNT_ID: ${{ secrets.R2_ACCOUNT_ID }}
        R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
        R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
      run: |
        git lfs install
        git lfs pull
        go run ./cmd/bundleresources

    - name: Create empty manifest (PR build)
      if: steps.cache.outputs.cache-hit != 'true' && github.event_name == 'pull_request'
      run: touch manifest.json

    - name: Upload manifest artifact
      uses: actions/upload-artifact@v4
      with:
        name: manifest-json
        path: manifest.json

  build-linux:
    name: Build Linux
    needs: bundle-resources
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0
        lfs: false

    - name: Setup go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache-dependency-path: go.sum

    - name: Check go install
      run: go version

    - name: Install Linux dependencies
      run: |
        sudo apt update
        sudo apt install xorg-dev libsdl2-dev libsystemd-dev

    - name: Get sherpa-onnx commit SHA
      id: sherpa-sha
      run: echo "sha=$(git -C sherpa-onnx rev-parse HEAD)" >> $GITHUB_OUTPUT

    - name: Cache sherpa-onnx build
      uses: actions/cache@v4
      with:
        path: sherpa-onnx/build_go
        key: sherpa-onnx-linux-${{ steps.sherpa-sha.outputs.sha }}

    - name: Build vice
      run: ./build.sh

    - name: Fetch videomaps for linting
      run: |
        git lfs install
        git lfs pull --include="resources/videomaps/*"

    - name: Check scenarios
      run: ./vice -lint

    - name: Download manifest
      uses: actions/download-artifact@v4
      with:
        name: manifest-json
        path: cmd/vice/

    - name: Build for release
      run: ./build.sh --release

    - name: Run tests
      run: go test -v ./...

  build-mac:
    name: Build macOS
    needs: bundle-resources
    runs-on: macos-latest

    env:
      MACOSX_DEPLOYMENT_TARGET: '13.0'
      CGO_CFLAGS: '-mmacosx-version-min=13.0'
      CGO_LDFLAGS: '-mmacosx-version-min=13.0'

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0
        lfs: false

    - name: Setup go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache-dependency-path: go.sum

    - name: Check go install
      run: go version

    - name: Install Mac dependencies
      run: brew install sdl2 pkg-config glfw

    - name: Get sherpa-onnx commit SHA
      id: sherpa-sha
      run: echo "sha=$(git -C sherpa-onnx rev-parse HEAD)" >> $GITHUB_OUTPUT

    - name: Cache sherpa-onnx build
      uses: actions/cache@v4
      with:
        path: sherpa-onnx/build_go
        key: sherpa-onnx-mac-${{ steps.sherpa-sha.outputs.sha }}

    - name: Build vice
      run: ./build.sh

    - name: Download manifest
      uses: actions/download-artifact@v4
      with:
        name: manifest-json
        path: cmd/vice/

    - name: Build universal binary
      run: ./build.sh --release --universal

    - name: Run tests
      run: go test -v ./...

    - name: Create Vice.app
      env:
        APPLE_DEVELOPER_ID_APPLICATION: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}
        APPLE_DEVELOPER_ID_CERT_FILE: ${{ secrets.APPLE_DEVELOPER_ID_CERT_FILE }}
        APPLE_DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_CERT_PASSWORD }}
        APPLE_CODESIGN_ID: ${{ secrets.APPLE_CODESIGN_ID2 }}
        APPLE_CODESIGN_PASSWORD: ${{ secrets.APPLE_CODESIGN_PASSWORD2 }}
        APPLE_TEAMID: ${{ secrets.APPLE_TEAMID }}
      run: ./osx/make-vice-app.sh

    - name: Create zip file for app
      run: zip -rv Vice-osx.zip Vice.app

    - name: Save zip file as build artifact
      uses: actions/upload-artifact@v4
      with:
        name: Vice-osx.zip
        path: Vice-osx.zip

    - name: Rename zip for release (maybe)
      if: startsWith(github.ref, 'refs/tags/')
      run: mv Vice-osx.zip 'Vice-${{ github.ref_name }}-osx.zip'

    - name: Upload release (maybe)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: 'Vice-${{ github.ref_name }}-osx.zip'

  build-windows:
    name: Build Windows
    needs: bundle-resources
    runs-on: windows-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        lfs: false
        fetch-depth: 0   # fetch whole history so we can get tags for the installer :-(
        submodules: true

    - name: Check git tags
      run: |
        git describe --tags --abbrev=8 --dirty --always --long
        git describe --tags --abbrev=0

    - name: Setup go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache-dependency-path: go.sum

    - name: Checkout Windows prebuilts
      uses: actions/checkout@v4
      with:
        repository: mmp/vice-windows-ext
        path: ./ext

    - name: Install windows prebuilts
      working-directory: ./ext
      shell: bash
      run: |
        unzip -q SDL2-devel-2.24.0-mingw.zip
        7z x x86_64-12.2.0-release-win32-seh-rt_v10-rev0.7z -omingw
        echo "${{ github.workspace }}/ext/mingw/mingw64/bin" >> $GITHUB_PATH
        ls

    - name: Install Vulkan SDK
      run: |
        $ErrorActionPreference = 'Stop'
        $vulkanVersion = "1.3.296.0"
        $installerUrl = "https://sdk.lunarg.com/sdk/download/$vulkanVersion/windows/VulkanSDK-$vulkanVersion-Installer.exe"
        $installerPath = "$env:TEMP\VulkanSDK-Installer.exe"

        Write-Host "Downloading Vulkan SDK $vulkanVersion..."
        Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath

        Write-Host "Installing Vulkan SDK..."
        Start-Process -FilePath $installerPath -ArgumentList "--accept-licenses --default-answer --confirm-command install" -Wait -NoNewWindow

        # Set environment variables for this job
        $sdkPath = "C:\VulkanSDK\$vulkanVersion"
        echo "VULKAN_SDK=$sdkPath" >> $env:GITHUB_ENV
        echo "$sdkPath\Bin" >> $env:GITHUB_PATH

        Write-Host "Vulkan SDK installed at $sdkPath"
      shell: pwsh

    - name: Copy runtime DLLs to windows/
      run: |
        cp ext/mingw/mingw64/bin/libgcc_s_seh-1.dll windows/
        cp ext/mingw/mingw64/bin/libstdc++-6.dll windows/
        cp ext/SDL2-2.24.0/x86_64-w64-mingw32/bin/SDL2.dll windows/

    - name: Get sherpa-onnx commit SHA
      id: sherpa-sha
      run: echo "sha=$(git -C sherpa-onnx rev-parse HEAD)" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Cache sherpa-onnx build
      id: cache-sherpa
      uses: actions/cache@v4
      with:
        path: sherpa-onnx/build_go
        key: sherpa-onnx-win-msvc-${{ steps.sherpa-sha.outputs.sha }}

    - name: Get whisper.cpp commit SHA
      id: whisper-sha
      run: echo "sha=$(git -C whisper.cpp rev-parse HEAD)" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Cache whisper.cpp build
      id: cache-whisper
      uses: actions/cache@v4
      with:
        path: whisper.cpp/build_go
        key: whisper-cpp-win-vulkan-${{ steps.whisper-sha.outputs.sha }}-sdk1.3.296.0

    - name: Build vice
      run: |
        Write-Host "VULKAN_SDK = $env:VULKAN_SDK"
        Write-Host "Checking for glslc.exe..."
        if (Test-Path "$env:VULKAN_SDK\Bin\glslc.exe") {
          Write-Host "Found glslc.exe at $env:VULKAN_SDK\Bin\glslc.exe"
        } else {
          Write-Host "glslc.exe NOT found at $env:VULKAN_SDK\Bin\glslc.exe"
          Write-Host "Listing $env:VULKAN_SDK\Bin:"
          Get-ChildItem "$env:VULKAN_SDK\Bin" -ErrorAction SilentlyContinue | Select-Object Name
        }
        # Add Vulkan SDK lib path to CGO_LDFLAGS
        $env:CGO_LDFLAGS = "-L ../ext/SDL2-2.24.0/x86_64-w64-mingw32/lib -L $env:VULKAN_SDK/Lib"
        .\build.bat --icons
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
      shell: pwsh
      env:
        CGO_CFLAGS: "-I ../ext/SDL2-2.24.0/x86_64-w64-mingw32/include"
        CGO_CPPFLAGS: "-I ../ext/SDL2-2.24.0/x86_64-w64-mingw32/include"

    - name: Verify Vulkan build
      run: |
        Write-Host "Checking for Vulkan library..."
        if (Test-Path "whisper.cpp\build_go\ggml\src\ggml-vulkan\ggml-vulkan.a") {
          Write-Host "✓ ggml-vulkan.a found - Vulkan support built successfully"
        } else {
          Write-Error "✗ ggml-vulkan.a not found - Vulkan build may have failed"
          exit 1
        }
      shell: pwsh

    - name: Check scenarios
      run: ./vice.exe -lint

    - name: Download manifest
      uses: actions/download-artifact@v4
      with:
        name: manifest-json
        path: cmd/vice/

    - name: Build for release (download resources)
      run: |
        $env:CGO_LDFLAGS = "-L ../ext/SDL2-2.24.0/x86_64-w64-mingw32/lib -L $env:VULKAN_SDK/Lib"
        .\build.bat --release
        go build -o ./crc2vice.exe ./cmd/crc2vice
        go build -o ./dat2vice.exe ./cmd/dat2vice
      shell: pwsh
      env:
        CGO_CFLAGS: "-I ../ext/SDL2-2.24.0/x86_64-w64-mingw32/include"
        CGO_CPPFLAGS: "-I ../ext/SDL2-2.24.0/x86_64-w64-mingw32/include"

    - name: Add WIX to path
      run: echo "C:\Program Files (x86)\WiX Toolset v3.14\bin" >> $GITHUB_PATH
      shell: bash

    - name: Create installer
      run: |
        .\windows\makeinstaller.bat

    - name: Save executable
      uses: actions/upload-artifact@v4
      with:
        name: vice.exe
        path: vice.exe

    - name: Save installer
      uses: actions/upload-artifact@v4
      with:
        name: Vice-installer.msi
        path: Vice-installer.msi

    - name: Rename installer for release (maybe)
      if: startsWith(github.ref, 'refs/tags/')
      run: move Vice-installer.msi 'Vice-${{ github.ref_name }}-installer.msi'

    - name: Upload release (maybe)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Vice-${{ github.ref_name }}-installer.msi
          dat2vice.exe
          crc2vice.exe
