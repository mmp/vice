name: CI

on:
  push:
    paths-ignore:
      - 'website/**'
      - '**.md'
  pull_request:
    paths-ignore:
      - 'website/**'
      - '**.md'

jobs:
  bundle-resources:
    name: Bundle Resources
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        lfs: false

    - name: Restore manifest from cache
      id: cache
      uses: actions/cache@v4
      with:
        path: manifest.json
        key: manifest-v1-${{ hashFiles('resources/**') }}

    - name: Setup Go
      if: steps.cache.outputs.cache-hit != 'true' && github.event_name != 'pull_request'
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache-dependency-path: go.sum

    - name: Fetch LFS and generate manifest
      if: steps.cache.outputs.cache-hit != 'true' && github.event_name != 'pull_request'
      env:
        VICE_GCS_CREDENTIALS: ${{ secrets.GCS_UPLOAD_CREDENTIALS }}
      run: |
        git lfs install
        git lfs pull
        go run ./cmd/bundleresources

    - name: Create empty manifest (PR build)
      if: steps.cache.outputs.cache-hit != 'true' && github.event_name == 'pull_request'
      run: touch manifest.json

    - name: Upload manifest artifact
      uses: actions/upload-artifact@v4
      with:
        name: manifest-json
        path: manifest.json

  build-linux:
    name: Build Linux
    needs: bundle-resources
    runs-on: ubuntu-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0
        lfs: false

    - name: Setup go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache-dependency-path: go.sum

    - name: Check go install
      run: go version

    - name: Install Linux dependencies
      run: |
        sudo apt update
        sudo apt install xorg-dev libsdl2-dev libsystemd-dev

    - name: Build vice
      run: ./build.sh

    - name: Fetch videomaps for linting
      run: |
        git lfs install
        git lfs pull --include="resources/videomaps/*"

    - name: Check scenarios
      run: ./vice -lint

    - name: Download manifest
      uses: actions/download-artifact@v4
      with:
        name: manifest-json
        path: cmd/vice/

    - name: Build for release
      run: ./build.sh --release

    - name: Run tests
      run: go test -v ./...

  build-mac:
    name: Build macOS
    needs: bundle-resources
    runs-on: macos-latest

    env:
      MACOSX_DEPLOYMENT_TARGET: '13.0'
      CGO_CFLAGS: '-mmacosx-version-min=13.0'
      CGO_LDFLAGS: '-mmacosx-version-min=13.0'

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        submodules: true
        fetch-depth: 0
        lfs: false

    - name: Setup go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache-dependency-path: go.sum

    - name: Check go install
      run: go version

    - name: Install Mac dependencies
      run: brew install sdl2 pkg-config glfw

    - name: Build vice
      run: ./build.sh

    - name: Download manifest
      uses: actions/download-artifact@v4
      with:
        name: manifest-json
        path: cmd/vice/

    - name: Build universal binary
      run: ./build.sh --release --universal

    - name: Run tests
      run: go test -v ./...

    - name: Create Vice.app
      env:
        APPLE_DEVELOPER_ID_APPLICATION: ${{ secrets.APPLE_DEVELOPER_ID_APPLICATION }}
        APPLE_DEVELOPER_ID_CERT_FILE: ${{ secrets.APPLE_DEVELOPER_ID_CERT_FILE }}
        APPLE_DEVELOPER_ID_CERT_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_CERT_PASSWORD }}
        APPLE_CODESIGN_ID: ${{ secrets.APPLE_CODESIGN_ID2 }}
        APPLE_CODESIGN_PASSWORD: ${{ secrets.APPLE_CODESIGN_PASSWORD2 }}
        APPLE_TEAMID: ${{ secrets.APPLE_TEAMID }}
      run: ./osx/make-vice-app.sh

    - name: Create zip file for app
      run: zip -rv Vice-osx.zip Vice.app

    - name: Save zip file as build artifact
      uses: actions/upload-artifact@v4
      with:
        name: Vice-osx.zip
        path: Vice-osx.zip

    - name: Rename zip for release (maybe)
      if: startsWith(github.ref, 'refs/tags/')
      run: mv Vice-osx.zip 'Vice-${{ github.ref_name }}-osx.zip'

    - name: Upload release (maybe)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: 'Vice-${{ github.ref_name }}-osx.zip'

  build-windows:
    name: Build Windows
    needs: bundle-resources
    runs-on: windows-latest

    steps:
    - name: Checkout source
      uses: actions/checkout@v4
      with:
        lfs: false
        fetch-depth: 0   # fetch whole history so we can get tags for the installer :-(
        submodules: true

    - name: Check git tags
      run: |
        git describe --tags --abbrev=8 --dirty --always --long
        git describe --tags --abbrev=0

    - name: Setup go
      uses: actions/setup-go@v5
      with:
        go-version-file: go.mod
        cache-dependency-path: go.sum

    - name: Checkout Windows prebuilts
      uses: actions/checkout@v4
      with:
        repository: mmp/vice-windows-ext
        path: ./ext

    - name: Install windows prebuilts
      working-directory: ./ext
      run: |
        unzip -q SDL2-devel-2.24.0-mingw.zip
        7z x x86_64-12.2.0-release-win32-seh-rt_v10-rev0.7z -omingw
        echo ${{ github.workspace }}/ext/mingw/mingw64 >> $GITHUB_PATH
        ls

    - name: Copy runtime DLLs to windows/
      run: |
        cp ext/mingw/mingw64/bin/libgcc_s_seh-1.dll windows/
        cp ext/mingw/mingw64/bin/libstdc++-6.dll windows/
        cp ext/SDL2-2.24.0/x86_64-w64-mingw32/bin/SDL2.dll windows/

    - name: Build vice
      run: .\build.bat --icons
      env:
        CGO_CFLAGS: "-I ../ext/SDL2-2.24.0/x86_64-w64-mingw32/include"
        CGO_CPPFLAGS: "-I ../ext/SDL2-2.24.0/x86_64-w64-mingw32/include"
        CGO_LDFLAGS: "-L ../ext/SDL2-2.24.0/x86_64-w64-mingw32/lib"

    - name: Check scenarios
      run: ./vice.exe -lint

    - name: Download manifest
      uses: actions/download-artifact@v4
      with:
        name: manifest-json
        path: cmd/vice/

    - name: Build for release (download resources)
      run: |
        .\build.bat --release
        go build -o ./crc2vice.exe ./cmd/crc2vice
        go build -o ./dat2vice.exe ./cmd/dat2vice
      env:
        CGO_CFLAGS: "-I ../ext/SDL2-2.24.0/x86_64-w64-mingw32/include"
        CGO_CPPFLAGS: "-I ../ext/SDL2-2.24.0/x86_64-w64-mingw32/include"
        CGO_LDFLAGS: "-L ../ext/SDL2-2.24.0/x86_64-w64-mingw32/lib"

    - name: Add WIX to path
      run: echo "C:\Program Files (x86)\WiX Toolset v3.14\bin" >> $GITHUB_PATH
      shell: bash

    - name: Create installer
      run: |
        .\windows\makeinstaller.bat

    - name: Save executable
      uses: actions/upload-artifact@v4
      with:
        name: vice.exe
        path: vice.exe

    - name: Save installer
      uses: actions/upload-artifact@v4
      with:
        name: Vice-installer.msi
        path: Vice-installer.msi

    - name: Rename installer for release (maybe)
      if: startsWith(github.ref, 'refs/tags/')
      run: move Vice-installer.msi 'Vice-${{ github.ref_name }}-installer.msi'

    - name: Upload release (maybe)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Vice-${{ github.ref_name }}-installer.msi
          dat2vice.exe
          crc2vice.exe
